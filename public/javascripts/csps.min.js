function get_date_months_ago(a){return moment().subtract(a,"months").startOf("month").format("YYYY-MM-DD")}function chart(a){function f(b){b.each(function(b){function v(a){var b=1,c="";return a>=1e3&&(b=1e3,c="k"),a>=1e6&&(b=1e6,c="m"),u(a/b)+c}function G(a){var b=F.some(function(b){return b===a});b||F.push(a)}if("undefined"==typeof a.max_value||0==a.max_value){var c=[];b.forEach(function(b,d){c.push(b[a.value])});var f=d3.max(c)}else f=a.max_value;var g;g="undefined"==typeof a.colours?["red","orange","yellow","green","blue","purple","violet","brown","#999"]:a.colours;var m,h=20,i=20,k=45,l=12,n=4,o={top:0,left:6,bottom:0,right:0};m="scatter"==a.type?Math.floor(e-d):0;var p=e-h-i-l-o.top-o.bottom-m,q=d-k-o.left-o.right,r=d3.select(this).append("svg").attr("height",e).attr("width",d).attr("id","chart_"+Math.floor(1e3*Math.random())).append("g").attr("id","minichart").attr("transform","translate("+o.left+","+o.top+")"),s=d3.scale.linear().domain([0,f]).range([0,q]),t=d3.scale.linear().domain([0,f]).rangeRound([p,0]),u=d3.format(".0f"),w=d3.svg.axis().scale(s).orient("bottom").outerTickSize(1).tickPadding(2).tickFormat(function(a){return v(a)}).ticks(5),x=d3.svg.axis().scale(t).orient("left").outerTickSize(1).tickPadding(2).tickFormat(function(a){return v(a)}).ticks(5);switch(a.type){case"bar":r.append("g").attr("id","x-axis").attr("transform","translate(0,"+h+")").call(w);var y=10,z="#999",A=p/b.length,B=d3.max([A-y,1]),C=q/f;r.append("g").attr("id","data_region").selectAll("rect").data(b).enter().append("rect").attr("y",function(a,b){return Math.abs(b*A)+h+i}).attr("height",B).attr("x",0).attr("width",function(b,c){return b[a.value]*C}).style("fill",z);break;case"scatter":var C=q/f,A=p/b.length,F=[];if("undefined"!=typeof a.measure&&""!=a.measure&&"demographic_summary"!=a.action){b.forEach(function(a,b){G(a.response_category)});var H;H=F.length>0?q/F.length:q/2,r.append("g").attr("id","categories").selectAll("text").data(F).enter().append("text").attr("x",-h-p-l-o.top).attr("y",function(a,b){return Math.abs(b*H)+k}).attr("dy",2+n+"px").attr("transform","rotate(-90)").attr("style","font-size: 0.55em; font-family: Lato; text-anchor: end").text(function(a){return a}),r.append("g").attr("id","data_region").selectAll("circle").data(b).enter().append("circle").attr("cx",function(a){return Math.abs(F.indexOf(a.response_category)*H)+k+n}).attr("cy",function(a){return h+l+o.top+t(a.demographic_total)}).attr("r",2.5).style("fill",function(b){return"undefined"!=typeof a.demographics?g[a.demographics.indexOf(b.demographic_category)]:"skyblue"})}else r.append("g").attr("id","data_region").selectAll("circle").data(b).enter().append("circle").attr("cx",function(a){return k+n}).attr("cy",function(a){return h+l+o.top+t(a.demographic_total)}).attr("r",2.5).style("fill",function(b){return g[a.demographics.indexOf(b.demographic_category)]}),r.select("#data_region").selectAll("line").data(b).enter().append("line").attr("x1",function(a){return k+n}).attr("y1",function(a){return h+l+o.top+t(a.demographic_total)}).attr("x2",function(a){return k+n+20}).attr("y2",function(a){return h+l+o.top+t(a.demographic_total)}).attr("stroke-width",2).attr("stroke",function(b){return g[a.demographics.indexOf(b.demographic_category)]}),r.select("#data_region").selectAll("text").data(b).enter().append("text").attr("x",function(a){return k+n+26}).attr("y",function(a){return h+l+o.top-12+t(a.demographic_total)}).attr("dy",h-3+"px").attr("style","font-size: 0.7em; font-family: Lato; text-anchor: start").text(function(a){return a.demographic_category});r.append("g").attr("id","y-axis").attr("transform","translate("+k+","+(h+l)+")").call(x)}r.append("g").attr("id","title").append("text").attr("x",2).attr("y",0).attr("dy",h-3+"px").attr("style","font-size: 1em; font-family: Lato; text-anchor: start").text(a.title)})}var b=12,c=40,d=(a.columns*screen.width-(b-1)*c)/b,e=1.41*d;return f.width=function(a){return arguments.length?(d=a,f):d},f.height=function(a){return arguments.length?(e=a,f):e},f}function get_data(a){d3.xhr("/xhr/").header("X-Requested-With","XMLHttpRequest").post(JSON.stringify(a),process_data)}function process_data(a,b){var c=JSON.parse(b.response),d=c.payload,e=c.search_params;(null!=d||d.length>0)&&d3.select(e.target).datum(d).call(chart(e))}function objectify(a,b){for(var c=[{org:"ALL_CS",year:"",headcount:"",cluster:"",org_ac:"",par_ac:""}],d=0;b>d;)c.push({org:d++,year:"",headcount:"",cluster:"ALL_CS",org_ac:"",par_ac:""});return a.forEach(function(a){c.push({org:a[0],year:a[1],headcount:a[2],cluster:a[3],org_ac:a[4],par_ac:a[5]})}),c}function get_clusters(a){d3.xhr("/xhr/").header("X-Requested-With","XMLHttpRequest").post(JSON.stringify(a),function(a,b){if(a)throw a;var c,e=[];c=JSON.parse(b.response),e.push(c.search_params),console.log(c);var f=c.search_params.cluster_options.n_clusters,g=d3_hierarchy.stratify().id(function(a){return a.org}).parentId(function(a){return a.cluster})(objectify(c.payload,f));switch(c.search_params.visualisation_style){case"circle_packing":var h=1400,i=d3.format(",d"),j=d3.layout.pack().size([h-4,h-4]).value(function(a){return 100}),k=d3.select("#comparison_similar_orgs").append("svg").attr("width",h).attr("height",h).append("g").attr("transform","translate(2,2)"),l=k.datum(g).selectAll(".node").data(j.nodes).enter().append("g").attr("class",function(a){return a.children?"node":"leaf node"}).attr("transform",function(a){return"translate("+a.x+","+a.y+")"});l.append("title").text(function(a){return a.id+(a.children?"":": "+i(a.size))}),l.append("circle").attr("r",function(a){return a.r}),l.filter(function(a){return!a.children}).append("text").attr("dy",".3em").style("text-anchor","middle").text(function(a){return a.id});break;case"dendrogram":default:var m=1200,n=1400,o=d3.layout.cluster().size([n,m-360]),p=d3.svg.diagonal().projection(function(a){return[a.y,a.x]}),k=d3.select("#comparison_similar_orgs").append("svg").attr("width",m).attr("height",n).append("g").attr("transform","translate(60,0)"),q=o.nodes(g),r=o.links(q),l=(k.selectAll(".link").data(r).enter().append("path").attr("class","link").attr("d",p),k.selectAll(".node").data(q).enter().append("g").attr("class","node").attr("transform",function(a){return"translate("+a.y+","+a.x+")"}));l.append("circle").attr("r",4.5),l.append("text").attr("dx",function(a){return a.children?-8:8}).attr("dy",3).style("text-anchor",function(a){return a.children?"end":"start"}).text(function(a){return a.id})}})}function get_graph_data_async(a){var b=queue();a.forEach(function(a){b.defer(d3.xhr("/xhr/").header("X-Requested-With","XMLHttpRequest").post,JSON.stringify(a))}),b.awaitAll(function(a,b){if(a)throw a;var c,f=0,g=[],h=[];b.forEach(function(a){c=JSON.parse(a.response),g.push(c.payload),h.push(c.search_params),c.payload.forEach(function(a){a[c.search_params.value]>f&&(f=a[c.search_params.value])})}),h.forEach(function(a){a.max_value=f});for(var i=0;i<g.length;i++)(null!=g[i]||g[i].length>0)&&d3.select(h[i].target).datum(g[i]).call(chart(h[i]))})}var org_list,survey_info,current_year=2014,current_org="CS",csps_orgs=[];$(function(){var a={self:this,organisations:ko.observableArray([]),current_organisation:ko.observable("CS"),survey_years:ko.observableArray([]),current_year:ko.observable(2014),current_algorithm:ko.observable("KMeans"),cluster_algorithms:ko.observableArray(["KMeans","MiniBatchKMeans","AffinityPropagation","MeanShift","SpectralClustering","AgglomerativeClustering","DBSCAN","Birch"]),num_clusters:ko.observable(3),update_survey_years:function(){d3.xhr("/xhr/").header("X-Requested-With","XMLHttpRequest").post(JSON.stringify({action:"survey_years"}),function(a,b){var c=JSON.parse(b.response);if(null!=c.payload||c.payload.length>0){var d=c.payload.map(function(a){return a.year});console.log(d)}})},update:ko.computed(function(){({title:"EEI",year:self.current_year,measure:"EEI",organisation:self.current_organisation,action:"scores_all",type:"bar",columns:3,x_axis:0,y_axis:0,value:"score",target:"#eei_all_chart"});console.log("--------------- update ---------------"),console.log(self.current_year),console.log(self.current_organisation)},this),init:function(){var a={n_clusters:4};get_clusters({title:"Clusters",year:self.current_year,organisation:current_org,action:"cluster",algorithm:"KMeans",engine:"scikit-learn",cluster_options:a,data_group:"themes",visualisation_style:"dendrogram"});var b;get_data({title:"EEI",year:self.current_year,measure:"EEI",organisation:current_org,action:"scores_all",type:"bar",columns:3,x_axis:0,y_axis:0,value:"score",target:"#eei_all_chart"}),get_data({title:"Headcount",year:current_year,measure:"",organisation:current_org,action:"headcount_total",type:"bar",columns:3,x_axis:0,y_axis:0,value:"headcount",target:"#headcount_total_chart"}),get_data({title:"Average scores",year:current_year,measure:"",organisation:current_org,action:"scores_average",type:"bar",columns:3,x_axis:0,y_axis:0,value:"mean",target:"#scores_average_chart"}),b=[{title:"Gender",year:self.current_year,measure:"Sex [J01]",organisation:"",action:"demographic_summary",type:"scatter",columns:2,x_axis:0,y_axis:1,value:"demographic_total",demographics:["Male","Female"],colours:["blue","red"],target:"#demographics_charts_01"},{title:"Ethnicity",year:self.current_year,measure:"Ethnicity - major group [J03]",organisation:"",action:"demographic_summary",type:"scatter",columns:2,x_axis:0,y_axis:0,value:"demographic_total",demographics:["White","Black","Asian","Mixed","Other ethnic group"],colours:["cornflowerblue","goldenrod","limegreen","royalblue","magenta"],target:"#demographics_charts_02"},{title:"Sexuality",year:self.current_year,measure:"Sexual identity [J07]",organisation:"",action:"demographic_summary",type:"scatter",columns:2,x_axis:0,y_axis:0,value:"demographic_total",demographics:["Heterosexual/straight","Gay, lesbian or bisexual","Other"],colours:["slategray","mediumvioletred","purple"],target:"#demographics_charts_03"},{title:"Health",year:self.current_year,measure:"Long-term health [J04]",organisation:"",action:"demographic_summary",type:"scatter",columns:2,x_axis:0,y_axis:0,value:"demographic_total",demographics:["No long-term limiting illness or condition","Long-term limiting illness or condition"],colours:["mediumaquamarine","palevioletred"],target:"#demographics_charts_04"}],get_graph_data_async(b),b=[{title:"Grade/gender",year:current_year,measure:"Grade",organisation:"",action:"demographics",type:"scatter",columns:2,x_axis:0,y_axis:1,value:"demographic_total",demographics:["male","female"],colours:["blue","red"],colours:["blue","red"],target:"#demographics_charts_06"},{title:"Grade/ethnicity",year:current_year,measure:"Grade",organisation:"",action:"demographics",type:"scatter",columns:2,x_axis:0,y_axis:0,value:"demographic_total",demographics:["white","bme"],colours:["cornflowerblue","goldenrod"],target:"#demographics_charts_07"},{title:"Grade/sexuality",year:current_year,measure:"Grade",organisation:"",action:"demographics",type:"scatter",columns:2,x_axis:0,y_axis:0,value:"demographic_total",demographics:["heterosexual","LGB"],colours:["slategray","mediumvioletred"],target:"#demographics_charts_08"},{title:"Grade/health",year:current_year,measure:"Grade",organisation:"",action:"demographics",type:"scatter",columns:2,x_axis:0,y_axis:0,value:"demographic_total",demographics:["noLTLI","LTLI"],colours:["mediumaquamarine","palevioletred"],target:"#demographics_charts_09"},{title:"Grade",year:current_year,measure:"Grade",organisation:"",action:"demographics_by_total",type:"scatter",columns:2,x_axis:0,y_axis:0,value:"demographic_total",target:"#demographics_charts_10"}],get_graph_data_async(b),b=[{title:"Age/gender",year:current_year,measure:"Age [J02]",organisation:"",action:"demographics",type:"scatter",columns:2,x_axis:0,y_axis:1,value:"demographic_total",demographics:["male","female"],colours:["blue","red"],target:"#demographics_charts_11"},{title:"Age/ethnicity",year:current_year,measure:"Age [J02]",organisation:"",action:"demographics",type:"scatter",columns:2,x_axis:0,y_axis:0,value:"demographic_total",demographics:["white","bme"],colours:["cornflowerblue","goldenrod"],target:"#demographics_charts_12"},{title:"Age/sexuality",year:current_year,measure:"Age [J02]",organisation:"",action:"demographics",type:"scatter",columns:2,x_axis:0,y_axis:0,value:"demographic_total",demographics:["heterosexual","LGB"],colours:["slategray","mediumvioletred"],target:"#demographics_charts_13"},{title:"Age/health",year:current_year,measure:"Age [J02]",organisation:"",action:"demographics",type:"scatter",columns:2,x_axis:0,y_axis:0,value:"demographic_total",demographics:["noLTLI","LTLI"],colours:["mediumaquamarine","palevioletred"],target:"#demographics_charts_14"},{title:"Age",year:current_year,measure:"Age [J02]",organisation:"",action:"demographics_by_total",type:"scatter",columns:2,x_axis:0,y_axis:0,value:"demographic_total",target:"#demographics_charts_15"}],get_graph_data_async(b),b=[{title:"Caring/gender",year:current_year,measure:["Caring status [J05]","Childcare status [J06]"],organisation:"",action:"demographics",type:"scatter",columns:2,x_axis:0,y_axis:1,value:"demographic_total",demographics:["male","female"],colours:["blue","red"],target:"#demographics_charts_16"},{title:"Caring/ethnicity",year:current_year,measure:["Caring status [J05]","Childcare status [J06]"],organisation:"",action:"demographics",type:"scatter",columns:2,x_axis:0,y_axis:0,value:"demographic_total",demographics:["white","bme"],colours:["cornflowerblue","goldenrod"],target:"#demographics_charts_17"},{title:"Caring/sexuality",year:current_year,measure:["Caring status [J05]","Childcare status [J06]"],organisation:"",action:"demographics",type:"scatter",columns:2,x_axis:0,y_axis:0,value:"demographic_total",demographics:["heterosexual","LGB"],colours:["slategray","mediumvioletred"],target:"#demographics_charts_18"},{title:"Caring/health",year:current_year,measure:["Caring status [J05]","Childcare status [J06]"],organisation:"",action:"demographics",type:"scatter",columns:2,x_axis:0,y_axis:0,value:"demographic_total",demographics:["noLTLI","LTLI"],colours:["mediumaquamarine","palevioletred"],target:"#demographics_charts_19"},{title:"Caring",year:current_year,measure:["Caring status [J05]","Childcare status [J06]"],organisation:"",action:"demographics_by_total",type:"scatter",columns:2,x_axis:0,y_axis:0,value:"demographic_total",target:"#demographics_charts_20"}],get_graph_data_async(b),b=[{title:"Religion/gender",year:current_year,measure:"Religious identity [J08]",organisation:"",action:"demographics",type:"scatter",columns:2,x_axis:0,y_axis:1,value:"demographic_total",demographics:["male","female"],colours:["blue","red"],target:"#demographics_charts_21"},{title:"Religion/ethnicity",year:current_year,measure:"Religious identity [J08]",organisation:"",action:"demographics",type:"scatter",columns:2,x_axis:0,y_axis:0,value:"demographic_total",demographics:["white","bme"],colours:["cornflowerblue","goldenrod"],target:"#demographics_charts_22"},{title:"Religion/sexuality",year:current_year,measure:"Religious identity [J08]",organisation:"",action:"demographics",type:"scatter",columns:2,x_axis:0,y_axis:0,value:"demographic_total",demographics:["heterosexual","LGB"],colours:["slategray","mediumvioletred"],target:"#demographics_charts_23"},{title:"Religion/health",year:current_year,measure:"Religious identity [J08]",organisation:"",action:"demographics",type:"scatter",columns:2,x_axis:0,y_axis:0,value:"demographic_total",demographics:["noLTLI","LTLI"],colours:["mediumaquamarine","palevioletred"],target:"#demographics_charts_24"},{title:"Religion",year:current_year,measure:"Religious identity [J08]",organisation:"",action:"demographics_by_total",type:"scatter",columns:2,x_axis:0,y_axis:0,value:"demographic_total",target:"#demographics_charts_25"}],get_graph_data_async(b)}};ko.applyBindings(a),d3.xhr("/xhr/").header("X-Requested-With","XMLHttpRequest").post(JSON.stringify({action:"survey_years"}),function(b,c){var d=JSON.parse(c.response);if(null!=d.payload||d.payload.length>0){var e=d.payload.map(function(a){return a.year});a.survey_years(e),a.current_year(2014)}}),d3.xhr("/xhr/").header("X-Requested-With","XMLHttpRequest").post(JSON.stringify({year:current_year,action:"organisation_list",full_names:!0}),function(b,c){var d=JSON.parse(c.response);if(null!=d.payload||d.payload.length>0){var e=d.payload.map(function(a){return a.organisation});a.organisations(e),a.current_organisation("CS")}}),a.init()});var margin={top:140,right:40,bottom:120,left:70},width=8,height=200,chart_sep=120,horiz_sep=60,day_width=width,day_chart_width=7*width,num_charts=2,num_months=3,total_height=num_charts*(height+chart_sep),chart_x,ga_chart_params,pubs_chart,show_statistics=!0,show_ga=!0,show_mc=!0,today=moment().format("YYYY-MM-DD"),search_params={action:"ga",start_date:get_date_months_ago(num_months),end_date:today,start_time:"00:00:00",end_time:"23:59:59",rolling_avg_days:14,organisation:"",position:0,top:0,left:0},timespan=moment(search_params.end_date).diff(moment(search_params.start_date),"days");